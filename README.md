# Iowa Crop Insurance

<p>Due to licensing restrictions the data used in this project cannot be made publicly available.</p>

## corrYields.R

<p>this helper function initially creates a matrix of simulated yields for all counties and PP/HP ratios for each crop. This table is used in modellingApproach.R and RatingsEngine.R. This function takes an argument nsims representing how many simulated values to create based on each county’s historical yields. The simulated values are created by estimating the density functions for each county’s historical data and randomly sampling from this distribution. After iterating over each counties historical corn and soybean yields and storing their simulated values in a new matrix, a smoothed HCOP procedure is applied to re-introduce correlation. The Smoothed HCOP procedure uses a historical data matrix representing the historical PP/HP ratios and yields to generate a new matrix called HCOP that will be used to re-correlate the simulated data. Before doing so a random shock using a scaling parameter of 0.25 is applied to each value in the simulated data. Finally, the simulated data is re-sorted based on the rank orderings of the HCOP matrix to introduce correlation to it. The function then returns a list containing a matrix of the correlated simulated data, a matrix of the original historical data, and numerical mappings that are used to access the data for a particular county. For instance, a developer could select a row in the Map data frame that has a particular name and the 2nd and 3rd column values of that row contain index values that correspond to the simulated and historical yields for a county.</p>

## correlatePrices.R

<p>
Given a matrix of simulated county yields this function returns a matrix of the simulated yields that preserves the original correlations between counties while correlating each of the yields with its respective harvest price. This is achieved by calculating the simulated data’s correlation matrix and manually inserting a new user specified correlation value for each element that was the historic correlation between a yield and price. Next the simulated data is re-correlated with the rebuilt correlation matrix using the Iman Conover Process. This allows specific modelling constraints to be enforced on the producer level while preserving correlations at the county level. 
</p>

## RatingsEngine.R

<p>
  This function computes the premium level and rate for a producer given their county, crop type, APH, coverage level, projected price, implied volatility, a time duration, and yield price correlation. The function first obtains a counties simulated and historical yields from the corrYields.R function. Next it creates future simulated harvest prices in the future using a Monte-Carlo simulation method. The function then adds shocks based on the county’s historical farm residuals to the simulated yields. Next the function uses Iman Conover process to correlate the producer’s yields with the user specified yield price correlation. Finally, the function computes the producer’s premium level and premium rate as specified by the RMA and the projects requirements. Note due to the simulation set up for the entire BOB this function is NOT used in modellingApproach.R. 
Lines 90-120 include example runs for how this function can be used to generate a premium rate and level for hypothetical producers.   
</p>

## modellingApproach.R

<p>
  This script is used to obtain the VAR 99% and VAR 99.6% Loss Ratios for each county as well as for the entire BOB. The script contains two functions farm_sim() and simulate_loss_ratio_var(). 
	Both utilize the matrix of simulated and historical yields generated by the corrYields() function. The simulated data matrix derived from corrYields then has its yields correlated with simulated harvest prices. This is done by first creating simulated harvest prices using Monte Carlo Simulation for both corn and soy. Next these simulated values along with the most recent yield price correlations for 2024 and the original simulated data matrix are fed into the correlatePrices() function to create a new matrix. Each row of this matrix represents a particular scenario across all counties while preserving the counties’ yield correlation with each other and correlation with harvest price. This matrix is used within the farm_sim() function to simulate insurance payouts for producers in different counties. Let’s call this matrix X.
The farm_sim() function is used to create a list of vectors representing potential payouts and premiums for a producer’s corn and soy insurance policy. This function takes a farmQauntile, fips_code, coverage level, projected price for corn and soy, the number of acres planted of soy and corn for the producer, and a random seed. farmQauntile specifies the quality of the farms APH relative to the county it is in and is used to generate more realistic county loss ratios in simulate_loss_ratio_var(). Fips_code specifies what county a farmer is in and ensures that the correct county yields are used in the simulation. The function starts by pulling the correct historical and simulated county yields from matrix X. 
Next it pulls farm level residuals for both corn and soy and correlates them using the Iman Conover Process. The function then adds the correlated shocks to the simulated corn and soybean vectors and truncates any negative values at zero. Next the matrix adjusts the producers APH up or down based on its farmQuantile. For example, if the farm had a low quantile it would have an APH below the counties mean APH. A quantile of ~50% would cause the farm to have an APH very close the counties mean APH. Next the quoted premium and simulated payouts to the farmers are calculated based on the project’s specifications and the RMA. The function then scales these payments and premiums by the number of acres the farmer has planted in soy and corn. Finally, a list containing a vector of potential joint, and crop specific payment and premiums is returned by the function. 
simulate_loss_ratio_var() uses farm_sim() to calculate potential payouts and premiums for 10 farmers in each county for all counties included in this project. The function stores the payments and premiums received from each of the 10 farms into two separate matrices. Each farm in a county is assigned a farmQuantile score ranging from 10%-90%. After computing the simulated premium and payments for each farm in a county via the farm_sim() function the matrices are row summed to create a vector of potential county payouts and premiums collected. Next these vectors are added to two vectors representing the entire BOBs collected premiums and payouts to farmers. The function then computes the county’s loss ratio, average loss ratio, 99% VAR and VAR. 99.6%.
This process is then repeated for each county in the project. Afterwards the final loss ratio, 99% VAR, 99.6% VAR, and average loss ratio are computed for the entire BOB. Finally, the average, 99% VAR, and 99.6% VAR of the loss ratio for all counties and BOB is visualized. Lines 289-295 ensure that the counties losses are still correlated and the correlation structure present in the counties’ yields successfully propagated to its losses. 
</p>
